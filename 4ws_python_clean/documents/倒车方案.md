MPC 实现倒车功能的修改方案
基于代码分析，要让 MPC 支持倒车，需要在以下几个方面进行修改：

1. 速度约束修改 （最关键）
位置: 
sim.py
 第 656 行和第 793 行

现状:

python
U_next = float(np.clip(self.ctrl.U + dU_cmd, 0.0, self.U_max))
需要改为:

将下限从 0.0 改为负值（例如 -5.0 表示允许最大 5 m/s 的倒车速度）
增加一个新参数 U_min_reverse 或直接使用 -U_max
2. 参数系统扩展
位置: 
params.py

需要添加:

U_reverse_max: 倒车最大速度（绝对值）
可能需要修改 U_eff() 方法，使其在倒车时也能正确处理（保留符号而不是取绝对值）
3. 动力学模型适配
位置: 
twodof.py
 和相关动力学函数

现状问题:

第 39 行: U = p.U_eff() 返回 max(abs(U), U_min) - 丢失了符号
需要保留速度符号以正确计算倒车时的动力学
修改方案:

创建新方法 U_signed_eff(): 返回带符号的有效速度
在动力学计算中使用带符号的速度
对于侧偏角计算，需要用 sign(vx) * max(|vx|, U_min) 保持方向
4. MPPI 控制器约束
位置: 
mppi_iface.py

需要修改:

速度采样范围：允许负值采样
速度约束上下界：从 [0, U_max] 改为 [U_min_reverse, U_max]
第 365 行的 U_eff = max(abs(p.U), p.U_min) 需要改为带符号版本
5. MPC 求解器适配
位置: 
mpc.py

好消息: MPC 已经使用 U_signed，理论上支持负速度

可能需要调整:

确认线性化时使用的是带符号速度
检查参考横摆率 r_ref = U_signed * kappa 在倒车时的符号正确性（倒车时应该反向）
6. 轨迹规划
位置: planner.py 和参考轨迹生成

需要考虑:

倒车轨迹的速度应为负值
航向角在倒车时的定义（是车头朝向还是运动方向）
可能需要特殊标记倒车段
7. 控制逻辑调整
位置: 
sim.py
 中的几何回退和简单控制器

需要修改:

_fallback_geom_3dof()
: 弯道限速逻辑需要考虑倒车
_autop_update_simple()
: 纯追踪公式在倒车时可能需要反向
8. 低速融合逻辑
位置: 
sim.py
 第 154-165 行（2DOF）和 237-261 行（3DOF）

现状: 使用 U_mag = abs(U) 或 abs(vx) 判断低速

需要调整:

低速判断应该用绝对值（保持现状）
但几何目标计算需要用带符号速度：r_des = U_signed * kappa
总体修改优先级
高优先级（必须修改）:

速度约束下限（
sim.py
 两处）
U_eff() 改为带符号版本（
params.py
）
MPPI 速度边界（
mppi_iface.py
）
中优先级（建议修改）: 4. 动力学模型中的速度符号处理（
twodof.py
, 
threedof.py
） 5. 几何控制器的倒车适配（
sim.py
）

低优先级（可选优化）: 6. 轨迹规划工具支持倒车段标记 7. 前端显示倒车状态

测试建议
修改后需要测试：

静止启动倒车: 从 U=0 开始给负速度指令
前进切换倒车: 从正速度平滑过渡到负速度
倒车转弯: 负速度下的转向控制
低速区间: 确认 |U| < U_min 时的行为正确
